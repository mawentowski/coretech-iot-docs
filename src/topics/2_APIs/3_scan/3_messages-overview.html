<h2 id="service-bus-messages-1">Service Bus Messages</h2>
<p>
    The following is not an exhaustive list of all possible Service Bus
    <code class="inline-code">Message Types</code>. Only the most common ones
    encountered when sending Scan API requests are described.
</p>
<h3 id="scandevicestatus">ScanDeviceStatus</h3>
<h4 id="devicestatus-as-online">
    <code class="inline-code">DeviceStatus</code> as
    <code class="inline-code">Online</code>
</h4>
<p>
    After you connect to a device, a
    <code class="inline-code">ScanDeviceStatus</code> message is displayed on
    the Service Bus that should indicate the
    <code class="inline-code">DeviceStatus</code> is
    <code class="inline-code">Online</code> with the
    <code class="inline-code">DeviceInUse</code> property set to
    <code class="inline-code">false</code>.
</p>
<pre><code class="language-JSON">{
    "DeviceStatus": "Online",
    "DeviceInUse": "false"
}
</code></pre>
<p class="caption">
    <code class="inline-code">ScanDeviceStatus</code> Service Bus Message Body
    showing the scan device is <code class="inline-code">Online</code> and not
    currently 'In Use'
</p>
<div class="alert-section info-alert">
    <div class="">
        <p>
            <strong>Note</strong>:
            <code class="inline-code">"DeviceInUse": "false"</code>
            is the default value when no application instance has reserved the
            device ( <code class="inline-code">/scan/v2/startscanning</code>).
        </p>
    </div>
    <h4 id="devicestatus-changes-1">
        <code class="inline-code">DeviceStatus</code> Changes
    </h4>
    <p>
        If a device status changes from
        <code class="inline-code">Online</code> to
        <code class="inline-code">Offline</code> or
        <code class="inline-code">PoweredOff</code>, a
        <code class="inline-code">ScanDeviceStatus</code> message is sent with
        an updated <code class="inline-code">DeviceStatus</code>.
    </p>
    <p>
        The following sample message is returned when the
        <code class="inline-code">DeviceStatus</code> of an exclusively reserved
        device changes to <code class="inline-code">PoweredOff</code>.
    </p>
    <pre><code class="language-json">{
    "DeviceStatus": "PoweredOff",
    "DeviceInUse": "true"
}
</code></pre>
    <p class="caption">
        <code class="inline-code">ScanDeviceStatus</code> Service Bus Message
        Body showing the scan device is
        <code class="inline-code">PoweredOff</code>
    </p>
    <h4 id="deviceinuse-as-true">
        <code class="inline-code">DeviceInUse</code> as
        <code class="inline-code">True</code>
    </h4>
    <p>
        A connection to scan device (
        <code class="inline-code">/session/v2/connections</code>) is not enough
        to receive unsolicited scan data from that device. The airline backend
        needs to tell the device it wants to receive scan data 'exclusively' by
        sending a
        <code class="inline-code">/scan/v2/startscanning</code> request.
        'Exclusively' using a device means it is locked and will only send scan
        data to airline backend that made the request.
    </p>
    <p>
        Upon making a
        <code class="inline-code">/scan/v2/startscanning</code> request, the
        Scan API acknowledges the request with a synchronous message, returning
        a <code class="inline-code">2xx</code> success status code (as seen in a
        tool like Postman) and an
        <code class="inline-code">accessExpiryTime</code> in the Response Body.
    </p>
    <pre><code class="language-json">{
    "accessExpiryTime": "2021-09-30T14:50:07.347Z"
}
</code></pre>
    <p class="caption">
        Scan API Response Body containing date-time when exclusive access to the
        device expires
    </p>
    <p>
        Unless explicitly released through a
        <code class="inline-code">/scan/v2/stopscanning</code> request,
        exclusive access to the device will automatically release once the
        <code class="inline-code">accessExpiryTime</code> has been reached. This
        date-time is <strong>5 minutes</strong> from the time the
        <code class="inline-code">/scan/v2/startscanning</code> request was
        made.
    </p>
    <div class="alert-section info-alert">
        <div class="">
            <p>
                <strong>Note</strong>: Subsequent calls to
                <code class="inline-code">/scan/v2/startscanning</code> will
                extend the <code class="inline-code">accessExpiryTime</code> by
                five minutes from the time of the request. Repeated requests can
                be used to maintain exclusive access for a longer period.
            </p>
        </div>
        <p>
            Now that the request has been successfully made, the Scan API sends
            the
            <code class="inline-code">DeviceID</code> of the device to the IoT
            Hub where it is then routed to the correct workstation and
            peripheral. After carrying out the command, another
            <code class="inline-code">ScanDeviceStatus</code> message is routed
            to the Service Bus subscription.
        </p>
        <p>
            In the Message Body, the
            <code class="inline-code">DeviceInUse</code> property is set to
            <code class="inline-code">true</code> which indicates that the
            device is now exclusively reserved and now may begin sending
            messages to the airline backend that made the
            <code class="inline-code">/scan/v2/startscanning</code> request.
        </p>
        <pre><code class="language-json">{
    "DeviceStatus": "Online",
    "DeviceInUse": "true"
}
</code></pre>
        <p class="caption">
            <code class="inline-code">DeviceStatus</code> Service Bus Message
            Body indicating the device is exclusively reserved by the airline
            backend
        </p>
        <div class="alert-section info-alert">
            <div class="">
                <p>
                    The same
                    <code class="inline-code">ScanDeviceStatus</code> message is
                    sent to all subscribers with an active connection to the
                    scan device to indicate the device can no longer be given a
                    <code class="inline-code">/scan/v2/startscanning</code>
                    request.
                </p>
            </div>
            <h4 id="deviceinuse-as-false">
                <code class="inline-code">DeviceInUse</code> as
                <code class="inline-code">False</code>
            </h4>
            <p>
                When input from the device is no longer needed, make a
                <code class="inline-code">/scan/v2/stopscanning</code> request
                to release exclusive access to the device so it can be used by
                other airline backends.
            </p>
            <p>
                The Scan API acknowledges the request with a synchronous
                message, returning a
                <code class="inline-code">2xx</code> success status code (as
                seen in a tool like Postman).
            </p>
            <p>
                An asynchronous
                <code class="inline-code">ScanDeviceStatus</code> message is
                sent to all subscribers with an active connection to the scan
                device to indicate the device is no longer exclusively being
                used (<code>"DeviceInUse": "false"</code>) and is available to
                successfully receive a
                <code class="inline-code">/scan/v2/startscanning</code> request.
            </p>
            <pre><code class="language-JSON">{
    "DeviceStatus": "Online",
    "DeviceInUse": "false"
}
</code></pre>
            <p class="caption">
                <code class="inline-code">DeviceStatus</code> Service Bus
                Message Body indicating the device is no longer 'in use' and is
                available to be reserved
            </p>
            <h3 id="barcoderead">BarcodeRead</h3>
            <p>
                When the device executes a scan, a message is sent to the
                Service Bus containing data in the Message Body determined by
                the type of scan. The type of device determines the
                <code class="inline-code">MessageType</code>, as well as the
                type of data returned.
            </p>
            <p>
                For example, an LSR device that scans a barcode returns a
                <code class="inline-code">BarcodeRead</code> message on the
                Service Bus, providing the string that contains the barcode (
                <code class="inline-code">BarCodeData</code>) as well as the
                type of barcode ( <code class="inline-code">BarCodeType</code>).
                The type of barcode can be 1D, 2D, etc.
            </p>
            <pre><code class="language-JSON">{
    "BarCodeData":"6M1AZKUR AHMETKUR ERG6ULZ ZRHISTTK 1912 211Y024F0028 150&gt;10B1OO2211BTK 292352404859427 1 020K X\r\n",
    "BarCodeType":"6"
}
</code></pre>
            <p class="caption">
                <code class="inline-code">BarcodeRead</code> Service Bus Message
                Body that returned barcode data scanned by an LSR device
            </p>
            <h3 id="magneticcardread">MagneticCardRead</h3>
            <p>
                An MSR device that scans the magnetic strip on the back of a
                payment card returns a
                <code class="inline-code">MagneticCardRead</code> message on the
                Service Bus, providing the
                <code class="inline-code">CardType</code> and
                <code class="inline-code">Track</code> data.
            </p>
            <pre><code class="language-JSON">{
   "CardType":"OtherCard",
   "Track1":"8102172196=000",
   "Track2":"18102172196=10=31122004=",
   "Track3":"",
   "Track4":""
}
</code></pre>
            <p class="caption">
                <code class="inline-code">MagneticCardRead</code> Service Bus
                Message Body that returned credit card data scanned by an MSR
                device
            </p>
            <div class="alert-section info-alert">
                <div class="">
                    <p>
                        The magnetic stripe on the back of a card is separated
                        into 4 tracks/rows of data that are returned by the
                        Service Bus as multiple lines of
                        <code class="inline-code">Track</code> data in the
                        Message Body.
                    </p>
                </div>
                <h3 id="traveldocumentread">TravelDocumentRead</h3>
                <p>
                    An OCR device that scans a passport returns a
                    <code class="inline-code">TravelDocumentRead</code> message
                    on the Service Bus, providing the scanned passport data as
                    <code class="inline-code">MrzData</code> in the Message
                    Body.
                </p>
                <pre><code class="language-JSON">{
    "MrzData": "P&lt;D&lt;&lt;SCHMIDT&lt;&lt;KARL&lt;HEINZ&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;\r1234567897D&lt;&lt;0102030M0405063&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;8",
}
</code></pre>
                <p class="caption">
                    <code class="inline-code">TravelDocumentRead</code> Service
                    Bus Message Body that returned passport
                    <code class="inline-code">MrzData</code> scanned by an OCR
                    device
                </p>
            </div>
        </div>
    </div>
</div>
